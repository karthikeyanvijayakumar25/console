<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RTEMS: Flash Disk Device</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rtemslogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RTEMS
   &#160;<span id="projectnumber">5.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Flash Disk Device<div class="ingroups"><a class="el" href="group__RTEMSDeviceDrivers.html">Device Drivers</a> &raquo; <a class="el" href="group__rtems__libblock.html">Block Device Library</a> &raquo; <a class="el" href="group__rtems__blkdev.html">Block Device Management</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:flashdisk_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flashdisk_8h.html">flashdisk.h</a></td></tr>
<tr class="memdesc:flashdisk_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Interface to a Flash Disk Block Device. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrtems__fdisk__monitor__data.html">rtems_fdisk_monitor_data</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Disk Monitoring Data allows a user to obtain the current status of the disk.  <a href="structrtems__fdisk__monitor__data.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrtems__fdisk__segment__desc.html">rtems_fdisk_segment_desc</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Segment Descriptor holds, number of continuous segments in the device of this type, the base segment number in the device, the address offset of the base segment in the device, and the size of segment.  <a href="structrtems__fdisk__segment__desc.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrtems__fdisk__driver__handlers.html">rtems_fdisk_driver_handlers</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Low Level driver handlers.  <a href="structrtems__fdisk__driver__handlers.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrtems__fdisk__device__desc.html">rtems_fdisk_device_desc</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Device Descriptor holds the segments in a device.  <a href="structrtems__fdisk__device__desc.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structrtems__flashdisk__config.html">rtems_flashdisk_config</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">RTEMS Flash Disk configuration table used to initialise the driver.  <a href="structrtems__flashdisk__config.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gaae3e325729c8176e749bb3cee3f253b7"><td class="memItemLeft" align="right" valign="top"><a id="gaae3e325729c8176e749bb3cee3f253b7"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#gaae3e325729c8176e749bb3cee3f253b7">RTEMS_FLASHDISK_DEVICE_BASE_NAME</a>&#160;&#160;&#160;&quot;/dev/fdd&quot;</td></tr>
<tr class="memdesc:gaae3e325729c8176e749bb3cee3f253b7"><td class="mdescLeft">&#160;</td><td class="mdescRight">The base name of the flash disks. <br /></td></tr>
<tr class="separator:gaae3e325729c8176e749bb3cee3f253b7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab70a76e49bc92d0459c36e251ac7995d"><td class="memItemLeft" align="right" valign="top"><a id="gab70a76e49bc92d0459c36e251ac7995d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_ERASE_DISK</b>&#160;&#160;&#160;_IO('B', 128)</td></tr>
<tr class="separator:gab70a76e49bc92d0459c36e251ac7995d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad44667818efd4cdd28a2c7f79d9db666"><td class="memItemLeft" align="right" valign="top"><a id="gad44667818efd4cdd28a2c7f79d9db666"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_COMPACT</b>&#160;&#160;&#160;_IO('B', 129)</td></tr>
<tr class="separator:gad44667818efd4cdd28a2c7f79d9db666"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga480317177518e814f871a5e4eba798cf"><td class="memItemLeft" align="right" valign="top"><a id="ga480317177518e814f871a5e4eba798cf"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_ERASE_USED</b>&#160;&#160;&#160;_IO('B', 130)</td></tr>
<tr class="separator:ga480317177518e814f871a5e4eba798cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga95b6cf04a54c5435797366bede6588a0"><td class="memItemLeft" align="right" valign="top"><a id="ga95b6cf04a54c5435797366bede6588a0"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_MONITORING</b>&#160;&#160;&#160;_IO('B', 131)</td></tr>
<tr class="separator:ga95b6cf04a54c5435797366bede6588a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa45cdadec4be77c208d69008ad7f1c32"><td class="memItemLeft" align="right" valign="top"><a id="gaa45cdadec4be77c208d69008ad7f1c32"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_INFO_LEVEL</b>&#160;&#160;&#160;_IO('B', 132)</td></tr>
<tr class="separator:gaa45cdadec4be77c208d69008ad7f1c32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab389f3a22fcfe84cb92842c328dcefcc"><td class="memItemLeft" align="right" valign="top"><a id="gab389f3a22fcfe84cb92842c328dcefcc"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTEMS_FDISK_IOCTL_PRINT_STATUS</b>&#160;&#160;&#160;_IO('B', 133)</td></tr>
<tr class="separator:gab389f3a22fcfe84cb92842c328dcefcc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga907c65153df83bedad2668cbe3d8d120"><td class="memItemLeft" align="right" valign="top"><a id="ga907c65153df83bedad2668cbe3d8d120"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga907c65153df83bedad2668cbe3d8d120">RTEMS_FDISK_KBYTES</a>(_k)&#160;&#160;&#160;(UINT32_C(1024) * (_k))</td></tr>
<tr class="memdesc:ga907c65153df83bedad2668cbe3d8d120"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the number of kilo-bytes. <br /></td></tr>
<tr class="separator:ga907c65153df83bedad2668cbe3d8d120"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga73e85fdb0656e7ab09e8a63d48d8becf"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga73e85fdb0656e7ab09e8a63d48d8becf">RTEMS_FDISK_BACKGROUND_ERASE</a>&#160;&#160;&#160;(1 &lt;&lt; 0)</td></tr>
<tr class="separator:ga73e85fdb0656e7ab09e8a63d48d8becf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga6a5bec45cf7f7ada226478f09256bd1c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga6a5bec45cf7f7ada226478f09256bd1c">RTEMS_FDISK_BACKGROUND_COMPACT</a>&#160;&#160;&#160;(1 &lt;&lt; 1)</td></tr>
<tr class="separator:ga6a5bec45cf7f7ada226478f09256bd1c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4d81d60c676b7ad742f0a51b193c15b8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga4d81d60c676b7ad742f0a51b193c15b8">RTEMS_FDISK_CHECK_PAGES</a>&#160;&#160;&#160;(1 &lt;&lt; 2)</td></tr>
<tr class="separator:ga4d81d60c676b7ad742f0a51b193c15b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga47c3c0239203378502183004b56be45e"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga47c3c0239203378502183004b56be45e">RTEMS_FDISK_BLANK_CHECK_BEFORE_WRITE</a>&#160;&#160;&#160;(1 &lt;&lt; 3)</td></tr>
<tr class="separator:ga47c3c0239203378502183004b56be45e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ga3cbff7dffdac7250af3b513a24601f91"><td class="memItemLeft" align="right" valign="top"><a id="ga3cbff7dffdac7250af3b513a24601f91"></a>
typedef struct <a class="el" href="structrtems__fdisk__monitor__data.html">rtems_fdisk_monitor_data</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga3cbff7dffdac7250af3b513a24601f91">rtems_fdisk_monitor_data</a></td></tr>
<tr class="memdesc:ga3cbff7dffdac7250af3b513a24601f91"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Disk Monitoring Data allows a user to obtain the current status of the disk. <br /></td></tr>
<tr class="separator:ga3cbff7dffdac7250af3b513a24601f91"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0af0a297f5876583c22f099ac54688c7"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structrtems__fdisk__segment__desc.html">rtems_fdisk_segment_desc</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga0af0a297f5876583c22f099ac54688c7">rtems_fdisk_segment_desc</a></td></tr>
<tr class="memdesc:ga0af0a297f5876583c22f099ac54688c7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Segment Descriptor holds, number of continuous segments in the device of this type, the base segment number in the device, the address offset of the base segment in the device, and the size of segment.  <a href="#ga0af0a297f5876583c22f099ac54688c7">More...</a><br /></td></tr>
<tr class="separator:ga0af0a297f5876583c22f099ac54688c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3e36a0fb2b70165104f1d988f33cd029"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structrtems__fdisk__driver__handlers.html">rtems_fdisk_driver_handlers</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga3e36a0fb2b70165104f1d988f33cd029">rtems_fdisk_driver_handlers</a></td></tr>
<tr class="memdesc:ga3e36a0fb2b70165104f1d988f33cd029"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Low Level driver handlers.  <a href="#ga3e36a0fb2b70165104f1d988f33cd029">More...</a><br /></td></tr>
<tr class="separator:ga3e36a0fb2b70165104f1d988f33cd029"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4e1cf210089a66216e739c7ccd3ea84e"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structrtems__fdisk__device__desc.html">rtems_fdisk_device_desc</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga4e1cf210089a66216e739c7ccd3ea84e">rtems_fdisk_device_desc</a></td></tr>
<tr class="memdesc:ga4e1cf210089a66216e739c7ccd3ea84e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Flash Device Descriptor holds the segments in a device.  <a href="#ga4e1cf210089a66216e739c7ccd3ea84e">More...</a><br /></td></tr>
<tr class="separator:ga4e1cf210089a66216e739c7ccd3ea84e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8d4fff797358538766b3bb13be596811"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structrtems__flashdisk__config.html">rtems_flashdisk_config</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga8d4fff797358538766b3bb13be596811">rtems_flashdisk_config</a></td></tr>
<tr class="memdesc:ga8d4fff797358538766b3bb13be596811"><td class="mdescLeft">&#160;</td><td class="mdescRight">RTEMS Flash Disk configuration table used to initialise the driver.  <a href="#ga8d4fff797358538766b3bb13be596811">More...</a><br /></td></tr>
<tr class="separator:ga8d4fff797358538766b3bb13be596811"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga38fc68a069082118de0f8b389fcd004b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__ClassicStatus.html#ga545d41846817eaba6143d52ee4d9e9fe">rtems_device_driver</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga38fc68a069082118de0f8b389fcd004b">rtems_fdisk_initialize</a> (rtems_device_major_number major, rtems_device_minor_number minor, void *arg)</td></tr>
<tr class="separator:ga38fc68a069082118de0f8b389fcd004b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ga68b00046a3d3c3b702ae52bcb3286651"><td class="memItemLeft" align="right" valign="top"><a id="ga68b00046a3d3c3b702ae52bcb3286651"></a>
const <a class="el" href="structrtems__flashdisk__config.html">rtems_flashdisk_config</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga68b00046a3d3c3b702ae52bcb3286651">rtems_flashdisk_configuration</a> []</td></tr>
<tr class="memdesc:ga68b00046a3d3c3b702ae52bcb3286651"><td class="mdescLeft">&#160;</td><td class="mdescRight">External reference to the configuration. Please supply. Support is present in <a class="el" href="confdefs_8h.html" title="Evaluate Configuration Options.">confdefs.h</a> for providing this variable. <br /></td></tr>
<tr class="separator:ga68b00046a3d3c3b702ae52bcb3286651"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga6bc9f00bbbd031f76f3024fc91a4d0b0"><td class="memItemLeft" align="right" valign="top"><a id="ga6bc9f00bbbd031f76f3024fc91a4d0b0"></a>
uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__RTEMSFDisk.html#ga6bc9f00bbbd031f76f3024fc91a4d0b0">rtems_flashdisk_configuration_size</a></td></tr>
<tr class="memdesc:ga6bc9f00bbbd031f76f3024fc91a4d0b0"><td class="mdescLeft">&#160;</td><td class="mdescRight">External reference to the number of configurations. Please supply. Support is present in <a class="el" href="confdefs_8h.html" title="Evaluate Configuration Options.">confdefs.h</a> for providing this variable. <br /></td></tr>
<tr class="separator:ga6bc9f00bbbd031f76f3024fc91a4d0b0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Flash disk driver for RTEMS provides support for block based file systems on flash devices. The driver is not a flash file system nor does it try to compete with flash file systems. It currently does not journal how-ever block sequence numbering could be added to allow recovery of a past positions if a power down occurred while being updated.</p>
<p>This flash driver provides block device support for most flash devices. The driver has been tested on NOR type devices such as the AMLV160 or M28W160. Support for NAND type devices may require driver changes to allow speedy recover of the block mapping data and to also handle the current use of word programming. Currently the page descriptors are stored in the first few pages of each segment.</p>
<p>The driver supports devices, segments and pages. You provide to the driver the device descriptions as a table of device descriptors. Each device descriptor contain a table of segment descriptions or segment descriptors. The driver uses this information to manage the devices.</p>
<p>A device is made up of segments. These are also called sectors or blocks. It is the smallest erasable part of a device. A device can have differing size segments at different offsets in the device. The segment descriptors support repeating segments that are continuous in the device. The driver breaks the segments up into pages. The first pages of a segment contain the page descriptors. A page descriptor hold the page flags, a CRC for the page of data and the block number the page holds. The block can appear in any order in the devices. A page is active if it hold a current block of data. If the used bit is set the page is counted as used. A page moves from erased to active to used then back to erased. If a block is written that is already in a page, the block is written to a new page the old page is flagged as used.</p>
<p>At initialization time each segment's page descriptors are read into memory and scanned to determine the active pages, the used pages and the bad pages. If a segment has any erased pages it is queue on the available queue. If the segment has no erased pages it is queue on the used queue.</p>
<p>The available queue is sorted from the least number available to the most number of available pages. A segment that has just been erased will placed at the end of the queue. A segment that has only a few available pages will be used sooner and once there are no available pages it is queued on the used queue. The used queue hold segments that have no available pages and is sorted from the least number of active pages to the most number of active pages.</p>
<p>The driver is required to compact segments. Compacting takes the segment with the most number of available pages from the available queue then takes segments with the least number of active pages from the used queue until it has enough pages to fill the empty segment. As the active pages are moved they flagged as used and once the segment has only used pages it is erased.</p>
<p>A flash block driver like this never knows if a page is not being used by the file-system. A typical file system is not design with the idea of erasing a block on a disk once it is not being used. The file-system will normally use a flag or a location as a marker to say that part of the disk is no longer in use. This means a number of blocks could be held in active pages but are no in use by the file system. The file system may also read blocks that have never been written to disk. This complicates the driver and may make the wear, usage and erase patterns harsher than a flash file system. The driver may also suffer from problems if power is lost.</p>
<p>There are some flash disk specific <a class="el" href="structIO.html">IO</a> control request types. To use open the device and issue the ioctl() call.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> fd = <a class="code" href="open_8c.html#a62e93eb794fed24c0f46c6acda6ea510">open</a> (<span class="stringliteral">&quot;/dev/flashdisk0&quot;</span>, O_WRONLY, 0);</div><div class="line"><span class="keywordflow">if</span> (fd &lt; 0)</div><div class="line">{</div><div class="line">  printf (<span class="stringliteral">&quot;driver open failed: %s\n&quot;</span>, strerror (errno));</div><div class="line">  exit (1);</div><div class="line">}</div><div class="line"><span class="keywordflow">if</span> (ioctl (fd, RTEMS_FDISK_IOCTL_ERASE_DISK) &lt; 0)</div><div class="line">{</div><div class="line">  printf (<span class="stringliteral">&quot;driver erase failed: %s\n&quot;</span>, strerror (errno));</div><div class="line">  exit (1);</div><div class="line">}</div><div class="line">close (fd);</div></div><!-- fragment --> <h2 class="groupheader">Macro Definition Documentation</h2>
<a id="ga6a5bec45cf7f7ada226478f09256bd1c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga6a5bec45cf7f7ada226478f09256bd1c">&#9670;&nbsp;</a></span>RTEMS_FDISK_BACKGROUND_COMPACT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTEMS_FDISK_BACKGROUND_COMPACT&#160;&#160;&#160;(1 &lt;&lt; 1)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Leave the compacting of of used segment to the background handler. </p>

</div>
</div>
<a id="ga73e85fdb0656e7ab09e8a63d48d8becf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga73e85fdb0656e7ab09e8a63d48d8becf">&#9670;&nbsp;</a></span>RTEMS_FDISK_BACKGROUND_ERASE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTEMS_FDISK_BACKGROUND_ERASE&#160;&#160;&#160;(1 &lt;&lt; 0)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Leave the erasing of used segment to the background handler. </p>

</div>
</div>
<a id="ga47c3c0239203378502183004b56be45e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga47c3c0239203378502183004b56be45e">&#9670;&nbsp;</a></span>RTEMS_FDISK_BLANK_CHECK_BEFORE_WRITE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTEMS_FDISK_BLANK_CHECK_BEFORE_WRITE&#160;&#160;&#160;(1 &lt;&lt; 3)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Blank check the flash device before writing to them. This is needed if you think you have a driver or device problem. </p>

</div>
</div>
<a id="ga4d81d60c676b7ad742f0a51b193c15b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4d81d60c676b7ad742f0a51b193c15b8">&#9670;&nbsp;</a></span>RTEMS_FDISK_CHECK_PAGES</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTEMS_FDISK_CHECK_PAGES&#160;&#160;&#160;(1 &lt;&lt; 2)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Check the pages during initialisation to see which pages are valid and which are not. This could slow down initialising the disk driver. </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="ga4e1cf210089a66216e739c7ccd3ea84e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4e1cf210089a66216e739c7ccd3ea84e">&#9670;&nbsp;</a></span>rtems_fdisk_device_desc</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structrtems__fdisk__device__desc.html">rtems_fdisk_device_desc</a>  <a class="el" href="structrtems__fdisk__device__desc.html">rtems_fdisk_device_desc</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Flash Device Descriptor holds the segments in a device. </p>
<p>The placing of the segments in a device decriptor allows the low level driver to share the segment descriptors for a number of devices.</p>
<p>Typically this structure is part of a table of segments in the device which is referenced in the flash disk configuration table. The reference is kept in the driver and used all the time to manage the flash device, therefore it must always exist. </p>

</div>
</div>
<a id="ga3e36a0fb2b70165104f1d988f33cd029"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga3e36a0fb2b70165104f1d988f33cd029">&#9670;&nbsp;</a></span>rtems_fdisk_driver_handlers</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structrtems__fdisk__driver__handlers.html">rtems_fdisk_driver_handlers</a>  <a class="el" href="structrtems__fdisk__driver__handlers.html">rtems_fdisk_driver_handlers</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Flash Low Level driver handlers. </p>
<p>Typically this structure is part of a table of handlers in the device which is referenced in the flash disk configuration table. The reference is kept in the driver and used all the time to manage the flash device, therefore it must always exist. </p>

</div>
</div>
<a id="ga0af0a297f5876583c22f099ac54688c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0af0a297f5876583c22f099ac54688c7">&#9670;&nbsp;</a></span>rtems_fdisk_segment_desc</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structrtems__fdisk__segment__desc.html">rtems_fdisk_segment_desc</a>  <a class="el" href="structrtems__fdisk__segment__desc.html">rtems_fdisk_segment_desc</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Flash Segment Descriptor holds, number of continuous segments in the device of this type, the base segment number in the device, the address offset of the base segment in the device, and the size of segment. </p>
<p>Typically this structure is part of a table of segments in the device which is referenced in the flash disk configuration table. The reference is kept in the driver and used all the time to manage the flash device, therefore it must always exist. </p>

</div>
</div>
<a id="ga8d4fff797358538766b3bb13be596811"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8d4fff797358538766b3bb13be596811">&#9670;&nbsp;</a></span>rtems_flashdisk_config</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structrtems__flashdisk__config.html">rtems_flashdisk_config</a>  <a class="el" href="structrtems__flashdisk__config.html">rtems_flashdisk_config</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>RTEMS Flash Disk configuration table used to initialise the driver. </p>
<p>The unavailable blocks count is the number of blocks less than the available number of blocks the file system is given. This means there will always be that number of blocks available when the file system thinks the disk is full. The compaction code needs blocks to compact with so you will never be able to have all the blocks allocated to the file system and be able to full the disk.</p>
<p>The compacting segment count is the number of segments that are moved into a new segment. A high number will mean more segments with low active page counts and high used page counts will be moved into avaliable pages how-ever this extends the compaction time due to time it takes the erase the pages. There is no pont making this number greater than the maximum number of pages in a segment.</p>
<p>The available compacting segment count is the level when compaction occurs when writing. If you set this to 0 then compaction will fail because there will be no segments to compact into.</p>
<p>The info level can be 0 for off with error, and abort messages allowed. Level 1 is warning messages, level 1 is informational messages, and level 3 is debugging type prints. The info level can be turned off with a compile time directive on the command line to the compiler of: </p><pre class="fragment">-DRTEMS_FDISK_TRACE=0
</pre> 
</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga38fc68a069082118de0f8b389fcd004b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga38fc68a069082118de0f8b389fcd004b">&#9670;&nbsp;</a></span>rtems_fdisk_initialize()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__ClassicStatus.html#ga545d41846817eaba6143d52ee4d9e9fe">rtems_device_driver</a> rtems_fdisk_initialize </td>
          <td>(</td>
          <td class="paramtype">rtems_device_major_number&#160;</td>
          <td class="paramname"><em>major</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rtems_device_minor_number&#160;</td>
          <td class="paramname"><em>minor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>arg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Flash disk device driver initialization. Place in a table as the initialisation entry and remainder of the entries are the RTEMS block device generic handlers.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">major</td><td>Flash disk major device number. </td></tr>
    <tr><td class="paramname">minor</td><td>Minor device number, not applicable. </td></tr>
    <tr><td class="paramname">arg</td><td>Initialization argument, not applicable. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The rtems_device_driver is actually just rtems_status_code. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
